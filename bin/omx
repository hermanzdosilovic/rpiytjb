#!/bin/bash

# wait omxplayer to start playing
function wait_omxplayer {
  ./bin/dbuscontrol.sh status 2> /dev/null
  while [[ $? -ne 0 ]]; do
    ./bin/dbuscontrol.sh status 2> /dev/null
  done
}

# convert microseconds to hh:mm:ss
function convert {
  seconds=$(( $1 / 1000000 ))
  minutes=$(( $seconds / 60 ))
  hours=$(( $minutes / 60 ))
  seconds=$(( $seconds % 60 ))
  printf "%02d:%02d:%02d" $hours $minutes $seconds
}

omxplayer --vol $1 $2 &>/dev/null &
pid=$!
wait_omxplayer

duration="$(./bin/dbuscontrol.sh duration 2>/dev/null)"
lastPosition="$(./bin/dbuscontrol.sh position 2>/dev/null)"
while [[ $(( $duration - $lastPosition )) -gt 1000000 ]]; do
  position="$(./bin/dbuscontrol.sh position 2>/dev/null)"
  if [[ $? -ne 0 ]]; then
    ps -p $pid > /dev/null
    if [[ $? -ne 0 ]]; then
      rollbackPosition=$(($lastPosition - 1000000))
      hhmmss=$(convert $rollbackPosition)
      echo "Starting OMXPLAYER again at ${rollbackPosition}s := $hhmmss" 1>&2
      omxplayer --vol $1 --pos $hhmmss $2 &>/dev/null &
      pid=$!
      wait_omxplayer
    fi
  else
    lastPosition=$position
  fi
done
